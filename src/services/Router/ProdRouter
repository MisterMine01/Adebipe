<?php

namespace Api\Services;

use Api\Router\Request;
use Api\Router\Response;
use ReflectionMethod;

class Router
{
    /**
     * All routes of the application
     * @var array
     */
    private array $routes = ["ROUTES GO HERE"];

    /**
     * Mime types
     * @var array
     */
    private array $mime = ["MIME TYPES GO HERE"];

    /**
     * Logger
     * @var Logger
     */
    private Logger $logger;

    /**
     * Constructor
     * @param Logger $logger
     */
    public function __construct(Logger $logger)
    {
        $this->logger = $logger;
    }

    // CODE OF ROUTES GOES HERE

    /**
     * Get the response for a request
     * @param Request $request
     * @param Injector $injector
     * @return Response
     */
    public function getResponse(Request $request, Injector $injector): Response
    {
        // Remove double slashes
        $request->uri = preg_replace('(\/+)', '/', $request->uri);
        if (is_file("public" . $request->uri)) {
            // The request is a file
            $this->logger->info('Get file: ' . $request->uri);
            return new Response(file_get_contents("public" . $request->uri), 200, [
                'Content-Type' => $this->mime[pathinfo("public" . $request->uri, PATHINFO_EXTENSION)]
            ]);
        }
        $this->logger->info('Get response for request: ' . $request->uri);
        if (!isset($this->routes[$request->uri])) {
            $this->logger->info('Route not found');
            return new Response('Not found', 404);
        }
        if (!isset($this->routes[$request->uri][$request->method])) {
            $this->logger->info('Method not allowed');
            return new Response('Method not allowed', 405);
        }
        // Execute the route with the injector (the prod router doesn't need the injector but i'm lazy)
        $route = $this->routes[$request->uri][$request->method];
        $response = $injector->execute(new ReflectionMethod($this::class . '::' . $route), null, [
            Request::class => $request
        ]);
        if (!($response instanceof Response)) {
            throw new \Exception('Response is not an instance of Response');
        }
        return $response;
    }
}
